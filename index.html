<style>
    /* ... (CSS sedia ada) ... */
    
    #timer-container {
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--neon-red);
        color: #fff;
        padding: 10px 20px;
        font-family: 'JetBrains Mono';
        font-weight: bold;
        border: 2px solid #fff;
        z-index: 500;
        display: none; /* Hanya muncul selepas login */
        box-shadow: 0 0 15px rgba(255, 0, 60, 0.5);
    }

    .timer-low {
        animation: blink 1s infinite;
    }

    @keyframes blink {
        0% { opacity: 1; }
        50% { opacity: 0.3; }
        100% { opacity: 1; }
    }
</style>

<div id="timer-container">
    MASA TERSISA: <span id="time-display">30:00</span>
</div>

<script>
    // --- KONFIGURASI MASA ---
    const MASA_UJIAN_MINIT = 30; 
    let masaTersisaSaat = MASA_UJIAN_MINIT * 60;
    let pemasaInterval;

    // ... (Fungsi authenticate sedia ada) ...

    function startExam() {
        document.documentElement.requestFullscreen();
        document.getElementById('timer-container').style.display = 'block'; // Papar pemasa
        
        // Mula pengiraan detik
        pemasaInterval = setInterval(updateTimer, 1000);

        document.addEventListener('visibilitychange', () => {
            if(document.hidden && isExamActive) {
                // Logik amaran/nyawa sedia ada
                triggerViolation();
            }
        });
        initCanvas();
    }

    function updateTimer() {
        if (masaTersisaSaat <= 0) {
            clearInterval(pemasaInterval);
            alert("MASA TAMAT! Jawapan anda akan dihantar secara automatik.");
            submitExam(); // Hantar paksa
            return;
        }

        masaTersisaSaat--;
        
        const minit = Math.floor(masaTersisaSaat / 60);
        const saat = masaTersisaSaat % 60;
        
        const display = `${minit.toString().padStart(2, '0')}:${saat.toString().padStart(2, '0')}`;
        const el = document.getElementById('time-display');
        el.innerText = display;

        // Amaran jika baki masa kurang 5 minit
        if (masaTersisaSaat <= 300) {
            document.getElementById('timer-container').classList.add('timer-low');
        }
    }

    async function submitExam() {
        // Hentikan pemasa jika dihantar manual sebelum tamat
        clearInterval(pemasaInterval);
        
        const payload = {
            ic: userData.ic,
            nama: userData.nama,
            q1: document.getElementById('q1').value,
            q2: canvas.toDataURL(),
            q3: document.getElementById('q3').value,
            q4: document.getElementById('q4').value,
            violations: userData.violations,
            isAI: userData.isFlaggedAI,
            statusHantaran: masaTersisaSaat <= 0 ? "AUTO_SUBMIT_TIMEOUT" : "MANUAL_SUBMIT"
        };

        const btn = document.getElementById('submit-btn');
        btn.innerText = "PROTOKOL PENGHANTARAN AKTIF...";
        btn.disabled = true;

        try {
            // Gunakan URL Web App anda yang telah di-deploy semula
            await fetch(WEB_APP_URL, { 
                method: 'POST', 
                mode: 'no-cors', 
                body: JSON.stringify(payload) 
            });
            
            alert("SISTEM: Jawapan telah berjaya dihantar ke emel pensyarah.");
            // Tutup aplikasi
            document.body.innerHTML = "<div style='color:white;text-align:center;margin-top:20%;'><h1>UJIAN TAMAT</h1><p>Sila tutup tetingkap pelayar anda.</p></div>";
        } catch(e) {
            alert("RALAT: Gagal menghantar. Sila tangkap layar (screenshot) jawapan anda segera!");
        }
    }
</script>
