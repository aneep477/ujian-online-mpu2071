<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <title>UJIAN MPU2071 - IPG KAMPUS DARULAMAN</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --amber: #FFB800; --bg: #0d0d0d; }
        body { background: var(--bg); color: #fff; font-family: system-ui; padding: 20px; }
        .card { background: #161616; padding: 25px; border-radius: 10px; max-width: 800px; margin: auto; border: 1px solid #333; }
        input, textarea { width: 100%; background: #000; border: 1px solid #444; color: #fff; padding: 12px; margin: 10px 0; border-radius: 5px; box-sizing: border-box; }
        .btn { background: var(--amber); color: #000; padding: 15px; border: none; width: 100%; font-weight: bold; cursor: pointer; border-radius: 5px; }
        #canvas { background: #fff; border: 2px solid var(--amber); cursor: crosshair; touch-action: none; border-radius: 5px; }
        .hidden { display: none; }
        .q-text { font-weight: bold; color: var(--amber); margin-top: 25px; }
    </style>
</head>
<body>

<div id="login-zone" class="card">
    <h2 style="color: var(--amber)">PENGURUSAN KOKURIKULUM (MPU2071)</h2>
    <p>Masukkan IC untuk mula ujian:</p>
    <input type="text" id="ic-field" placeholder="Contoh: 981016065935">
    <button class="btn" id="btn-auth" onclick="startAuth()">MASUK SEKARANG</button>
</div>

<div id="exam-zone" class="card hidden">
    <div style="display:flex; justify-content:space-between; border-bottom:1px solid #333; padding-bottom:10px;">
        <span id="p-name"></span>
        <span id="timer" style="color:var(--amber); font-weight:bold;">30:00</span>
    </div>

    <p class="q-text">1. Berikan 5 matlamat kokurikulum selaras dengan Falsafah Pendidikan Negara. (5 Markah)</p>
    <textarea id="ans1" rows="4"></textarea>

    <p class="q-text">2. LUKIS CARTA ORGANISASI: Binakan struktur organisasi Persatuan Sejarah sekolah. (4 Markah)</p>
    <button type="button" onclick="clearDraw()" style="margin-bottom:5px; background:#444; color:#fff; border:none; padding:5px 10px; cursor:pointer;">Padam Lukisan</button><br>
    <canvas id="canvas" width="750" height="350"></canvas>

    <p class="q-text">3. Nyatakan kelompok gerak kerja kokurikulum dan contohnya. (6 Markah)</p>
    <textarea id="ans3" rows="4"></textarea>

    <p class="q-text">4. Nyatakan 5 tugas Bendahari Pasukan Kadet Remaja Sekolah. (5 Markah)</p>
    <textarea id="ans4" rows="4"></textarea>

    <button class="btn" style="margin-top:30px;" onclick="finishExam()">HANTAR & JANA PDF</button>
</div>

<script>
    const API = "https://script.google.com/macros/s/AKfycbyetp-HZUNQ6SSN_JN6wwxVz4Y53VFiecfzcJgX7Dp5D7DBjIWYvrebSV0EmdIBf0RSmA/exec";
    let user = null;
    let canvas, ctx, isDrawing = false;

    function startAuth() {
        const ic = document.getElementById('ic-field').value.replace(/-/g, "");
        document.getElementById('btn-auth').innerText = "MENYEMAK...";
        const s = document.createElement('script');
        s.src = `${API}?action=login&ic=${ic}&callback=onLogin`;
        document.body.appendChild(s);
    }

    function onLogin(r) {
        if(r.result === "success") {
            user = r.data; user.ic = document.getElementById('ic-field').value;
            document.getElementById('login-zone').className = "hidden";
            document.getElementById('exam-zone').className = "card";
            document.getElementById('p-name').innerText = user.nama;
            setupDraw(); startTimer();
        } else {
            alert("IC Tidak Dijumpai!");
            document.getElementById('btn-auth').innerText = "MASUK SEKARANG";
        }
    }

    function setupDraw() {
        canvas = document.getElementById('canvas'); ctx = canvas.getContext('2d');
        ctx.strokeStyle = "#000"; ctx.lineWidth = 2;
        const getPos = (e) => {
            const r = canvas.getBoundingClientRect();
            return { x: (e.clientX || e.touches[0].clientX) - r.left, y: (e.clientY || e.touches[0].clientY) - r.top };
        };
        const start = (e) => { isDrawing = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x, p.y); };
        const move = (e) => { if(!isDrawing) return; const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); };
        canvas.onmousedown = start; canvas.onmousemove = move; window.onmouseup = () => isDrawing = false;
        canvas.ontouchstart = start; canvas.ontouchmove = move;
    }

    function clearDraw() { ctx.clearRect(0, 0, canvas.width, canvas.height); }

    function startTimer() {
        let t = 1800;
        setInterval(() => {
            t--; let m = Math.floor(t/60), s = t%60;
            document.getElementById('timer').innerText = m + ":" + (s<10?"0"+s:s);
            if(t <= 0) finishExam();
        }, 1000);
    }

    async function finishExam() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("KUIZ MPU2071: " + user.nama, 20, 20);
        doc.text("Jawapan 1: " + document.getElementById('ans1').value, 20, 40);
        
        doc.addPage();
        doc.text("Soalan 2 (Carta Organisasi):", 20, 20);
        doc.addImage(canvas.toDataURL('image/png'), 'PNG', 15, 30, 180, 85);
        
        doc.save(`JAWAPAN_${user.no_matrik}.pdf`);

        fetch(API, { method: 'POST', mode: 'no-cors', body: JSON.stringify({action: 'submit', ic: user.ic}) });
        alert("Selesai! Sila simpan PDF."); location.reload();
    }
</script>
</body>
</html>
